<!DOCTYPE html>
<html
  :dir="lang === 'ar' ? 'rtl' : 'ltr'"
  lang="en"
  class="transition-colors duration-300"
  x-data="ibanApp()"
  x-init="init()"
  x-init="$watch('darkMode', val => {
    document.documentElement.classList.toggle('dark', val);
    localStorage.setItem('darkMode', val);
  })">
<head>
  <script>
    let savedPref = localStorage.getItem('darkMode');
    const expiryKey = 'darkModeSetAt';
    const now = Date.now();
    const maxAge = 24 * 60 * 60 * 1000; // 24 hours

    const lastSet = parseInt(localStorage.getItem(expiryKey), 10);
    if (!lastSet || now - lastSet > maxAge) {
      localStorage.removeItem('darkMode');
      localStorage.removeItem(expiryKey);
      savedPref = null;
    }

    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

    if (savedPref !== 'true' && savedPref !== 'false') {
      localStorage.removeItem('darkMode');
      savedPref = null;
    }

    const useDark = savedPref === 'true' ? true : savedPref === 'false' ? false : prefersDark;

    console.log('[DarkMode] Saved Pref:', savedPref, '| System Prefers Dark:', prefersDark);

    if (useDark) {
      document.documentElement.classList.add('dark');
      console.log('[DarkMode] ✅ Applied .dark class');
    } else {
      console.log('[DarkMode] 🌞 Defaulting to light');
    }
  </script>
  <script>
    // Watch system changes in real time (outside Alpine scope)
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      if (localStorage.getItem('darkMode') === null) {
        document.documentElement.classList.toggle('dark', e.matches);
      }
    });
  </script>
  <meta charset="UTF-8" />
  <title>Saudi IBAN Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
    };
  </script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100 flex flex-col items-center justify-center min-h-0 px-4 transition-colors duration-300">


  <!-- Toast -->
  <div 
    x-show="showToast" 
    x-transition 
    class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-white text-black dark:bg-gray-700 dark:text-white px-4 py-2 rounded shadow-lg ring-1 ring-gray-300 dark:ring-gray-500 z-50 text-sm"
    x-text="toastMessage"
    x-cloak
  ></div>

  <div class="fixed top-4 right-4 z-50 flex flex-col items-end gap-2 sm:flex-row sm:items-center sm:gap-2">
    <button 
      @click="toggleTheme()" 
      class="w-9 h-9 flex items-center justify-center rounded-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition"
      :title="darkMode ? (lang === 'en' ? 'Switch to Light Mode' : 'التبديل إلى الوضع الفاتح') : (lang === 'en' ? 'Switch to Dark Mode' : 'التبديل إلى الوضع الداكن')"
    >
      <span x-text="darkMode ? '🌞' : '🌙'" class="text-lg transition-transform duration-200 transform hover:scale-110"></span>
    </button>
    <button 
      @click="lang = lang === 'en' ? 'ar' : 'en'" 
      class="w-9 h-9 flex items-center justify-center rounded-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition"
      :title="lang === 'en' ? 'التبديل إلى العربية' : 'Switch to English'"
    >
      <span x-text="lang === 'en' ? '🇸🇦' : '🇬🇧'" class="text-lg transition-transform duration-200 transform hover:scale-110"></span>
    </button>
  </div>
  <div class="min-h-screen flex flex-col items-center justify-start pt-20">
    <div class="flex flex-col items-center justify-center h-[520px]">
      <div class="bg-white dark:bg-gray-800 dark:text-white p-6 sm:p-8 rounded-2xl w-[400px] h-[520px] text-center transition-colors duration-300 flex flex-col justify-between">
      <div class="mb-6">
        <h1 class="text-xl font-bold flex items-center justify-center gap-2 text-gray-900 dark:text-white"
            x-text="lang === 'en' ? '🇸🇦 Saudi IBAN Generator' : 'مولد الآيبان السعودي 🇸🇦'">
        </h1>
      </div>

      <!-- IBAN Display -->
      <div class="mb-4 text-left h-[120px] flex flex-col justify-center">
        <div>
          <p class="text-sm sm:text-base mb-1 font-semibold"
             x-text="lang === 'en' ? 'Generated IBAN:' : 'الآيبان المُولد:'"
             :class="lang === 'ar' ? 'text-right' : ''"></p>
          <p>
            <span 
              id="iban-text" 
              x-ref="ibanText" 
              class="text-blue-700 font-mono break-words min-h-[1.5rem] inline-block ltr:text-left rtl:text-left"
              x-text="animatedIban.length ? animatedIban.map((c, i) => (i > 1 && (i - 2) % 4 === 0 ? ' ' + c : c)).join('') : 'SA XXXX XXXX XXXX XXXX XXXX XX'">
            </span>
          </p>
          <p class="text-sm text-gray-600" :class="lang === 'ar' ? 'text-right' : ''">
            <span class="font-semibold" x-text="lang === 'en' ? 'Bank:' : 'البنك:'"></span>
            <span class="ml-1" x-text="animatedBankName"></span>
          </p>
          <div class="relative inline-block mt-3 w-full flex" :class="lang === 'ar' ? 'justify-end' : 'justify-start'">
            <button 
              @click="copyIban()" 
              :disabled="!generatedIban"
              class="bg-blue-600 dark:bg-blue-800 text-white px-4 py-2 rounded-full hover:bg-blue-700 transition text-sm disabled:opacity-50 disabled:cursor-not-allowed">
              <span x-text="lang === 'en' ? '📋 Copy' : '📋 نسخ'"></span>
            </button>
          </div>
        </div>
      </div>

      <!-- Bank Selector -->
      <div class="mb-4 text-left">
        <label class="text-sm font-semibold text-gray-700 dark:text-gray-300 block mb-1"
               x-text="lang === 'en' ? 'Choose a bank (optional):' : 'اختر بنكًا (اختياري):'"
               :class="lang === 'ar' ? 'text-right' : ''"></label>
        <div class="relative" x-data="{ dropdownOpen: false }">
          <div @click="dropdownOpen = !dropdownOpen"
               class="cursor-pointer bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 text-sm flex items-center justify-between">
            <div class="flex items-center gap-2">
              <template x-if="selectedBankCode && bankOptions[selectedBankCode]">
                <img :src="bankOptions[selectedBankCode].logo" alt="Logo" class="w-4 h-4" />
              </template>
              <template x-if="!selectedBankCode">
                <span>🎲</span>
              </template>
              <span x-text="selectedBankCode ? (lang === 'en' ? bankOptions[selectedBankCode].name : bankOptions[selectedBankCode].ar) : (lang === 'en' ? 'Random Bank' : 'بنك عشوائي')"></span>
            </div>
            <svg class="w-4 h-4 ml-2 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </div>
          <div x-show="dropdownOpen" @click.outside="dropdownOpen = false"
               class="absolute z-10 mt-1 w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded shadow-lg max-h-60 overflow-y-auto">
            <div @click="selectedBankCode = ''; dropdownOpen = false"
                 class="flex items-center px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer">
              <span x-text="lang === 'en' ? '🎲 Random Bank' : '🎲 بنك عشوائي'"></span>
            </div>
            <template x-for="(bank, code) in bankOptions" :key="code">
              <div @click="selectedBankCode = code; dropdownOpen = false"
                   class="flex items-center px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer">
                <img :src="bank.logo" alt="" class="w-5 h-5" :class="lang === 'ar' ? 'ml-2' : 'mr-2'" />
                <span x-text="lang === 'en' ? bank.name : bank.ar"></span>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Generate Button -->
      <button
        @click="generateIban()"
        type="button"
        class="w-full text-sm sm:text-base bg-green-600 dark:bg-green-800 text-white px-4 py-3 sm:px-6 rounded-full hover:bg-green-700 transition font-semibold"
      >
        <span x-text="lang === 'en' ? '🔁 Generate' : '🔁 توليد'"></span>
      </button>
      </div>
    </div>

    <div class="w-full max-w-xl text-left mt-8">
      <h2 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex justify-between items-center">
        <span x-text="lang === 'en' ? 'Recent IBANs:' : 'الآيبانات الأخيرة:'"></span>
        <button 
          @click="ibanHistory.length && clearHistory()" 
          :class="ibanHistory.length ? 'text-red-600 cursor-pointer' : 'text-gray-400 cursor-not-allowed'"
          class="text-xs transition"
          :disabled="!ibanHistory.length"
        >
          <span x-text="lang === 'en' ? '🗑️ Clear History' : '🗑️ مسح السجل'"></span>
        </button>
      </h2>
      <template x-if="ibanHistory.length">
        <div>
          <ul class="text-xs sm:text-sm space-y-1">
            <template x-for="(item, index) in ibanHistory" :key="item.iban">
              <li>
                <div class="flex flex-col sm:flex-row sm:items-center sm:gap-x-2">
                  <span
                    class="font-mono break-words leading-snug transition-colors duration-300"
                    :class="{
                      'text-gray-900 dark:text-white': index === 0,
                      'text-gray-700 dark:text-gray-200': index === 1,
                      'text-gray-600 dark:text-gray-300': index === 2,
                      'text-gray-500 dark:text-gray-400': index === 3,
                      'text-gray-400 dark:text-gray-500': index === 4,
                      'text-gray-300 dark:text-gray-600': index === 5,
                      'text-gray-200 dark:text-gray-700': index === 6,
                    }"
                    x-text="item.iban"
                  ></span>
                  <span class="hidden sm:inline">–</span>
                  <div class="flex items-center min-w-0" :class="lang === 'ar' ? 'gap-2' : 'gap-1'">
                    <template x-if="Object.entries(bankOptions).some(([_, b]) => b.name === item.bank || b.ar === item.bank)">
                      <template x-if="!item.bank.includes('Random') && !item.bank.includes('عشوائي')">
                        <img 
                          :src="Object.entries(bankOptions).find(([k, v]) => v.name === item.bank || v.ar === item.bank)?.[1]?.logo" 
                          alt="Logo" 
                          class="w-4 h-4 flex-shrink-0" 
                        />
                      </template>
                    </template>
                    <span 
                    x-text="lang === 'en' ? item.bank : (bankOptions[Object.keys(bankOptions).find(code => bankOptions[code].name === item.bank)]?.ar || item.bank)" 
                      :class="{
                        'text-gray-900 dark:text-white': index === 0,
                        'text-gray-700 dark:text-gray-200': index === 1,
                        'text-gray-600 dark:text-gray-300': index === 2,
                        'text-gray-500 dark:text-gray-400': index === 3,
                        'text-gray-400 dark:text-gray-500': index === 4,
                        'text-gray-300 dark:text-gray-600': index === 5,
                        'text-gray-200 dark:text-gray-700': index === 6,
                      }"
                      class="truncate block max-w-[90px] sm:max-w-[140px] md:max-w-[160px] lg:max-w-[180px] xl:max-w-[200px] font-normal align-middle transition-colors duration-300"
                      :title="item.bank"
                      style="vertical-align: middle;"
                    ></span>
                  </div>
                </div>
              </li>
            </template>
          </ul>
        </div>
      </template>
    </div>
  </div>

  <!-- Footer -->
  <footer class="fixed bottom-4 left-4 text-xs text-gray-500 dark:text-gray-400">
    Developed by 
    <a href="https://github.com/a-almazyad" target="_blank" class="underline hover:text-black dark:hover:text-white font-medium">
      @a-almazyad
    </a>
  </footer>

  <!-- AlpineJS Logic -->
  <script>
    function ibanApp() {
      return {
        lang: 'en',
        generatedIban: null,
        ibanHistory: [],
        selectedBankCode: '',
        animatedIban: [],
        animatedBankName: '',
        bankOptions: {
  '5':  { name: 'Alinma Bank', ar: 'مصرف الإنماء', logo: 'logos/alinma.png' },
  '10': { name: 'SNB', ar: 'البنك الأهلي السعودي', logo: 'logos/snb.png' },
  '15': { name: 'Bank Albilad', ar: 'بنك البلاد', logo: 'logos/bilad.png' },
  '20': { name: 'Riyad Bank', ar: 'بنك الرياض', logo: 'logos/riyad.png' },
  '30': { name: 'Arab National Bank', ar: 'البنك العربي الوطني', logo: 'logos/anb.png' },
  '36': { name: 'D360 Bank', ar: 'بنك دي٣٦٠', logo: 'logos/d360.png' },
  '45': { name: 'SABB', ar: 'ساب', logo: 'logos/sabb.png' },
  '55': { name: 'BSF', ar: 'البنك السعودي الفرنسي', logo: 'logos/fransi.png' },
  '60': { name: 'Bank AlJazira', ar: 'بنك الجزيرة', logo: 'logos/jazira.png' },
  '65': { name: 'Investment Bank', ar: 'البنك السعودي للاستثمار', logo: 'logos/saib.png' },
  '78': { name: 'STC Bank', ar: 'بنك إس تي سي', logo: 'logos/stc.png' },
  '80': { name: 'Al Rajhi Bank', ar: 'مصرف الراجحي', logo: 'logos/rajhi.png' }
},
        showToast: false,
        toastMessage: '',

        darkMode: false,
        showCopiedTooltip: false,

        init() {
          let stored = localStorage.getItem('darkMode');
          const expiryKey = 'darkModeSetAt';
          const now = Date.now();
          const maxAge = 24 * 60 * 60 * 1000; // 24 hours

          const lastSet = parseInt(localStorage.getItem(expiryKey), 10);
          if (!lastSet || now - lastSet > maxAge) {
            localStorage.removeItem('darkMode');
            localStorage.removeItem(expiryKey);
            stored = null;
          }

          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          if (stored !== 'true' && stored !== 'false') {
            localStorage.removeItem('darkMode');
            stored = null;
          }
          const activeDark = stored === 'true' ? true : stored === 'false' ? false : prefersDark;
          document.documentElement.classList.toggle('dark', activeDark);
          this.darkMode = activeDark;
        },

        toggleTheme() {
          this.darkMode = !this.darkMode;
          localStorage.setItem('darkMode', this.darkMode);
          localStorage.setItem('darkModeSetAt', Date.now().toString());
          document.documentElement.classList.toggle('dark', this.darkMode);
        },

        loadHistory() {
          const stored = JSON.parse(localStorage.getItem('ibanHistory') || '[]');
          this.ibanHistory = stored;
        },

        generateIban() {
          const bankCode = this.selectedBankCode || 'random';
          let actualBankCode = bankCode;

          if (bankCode === 'random') {
            const keys = Object.keys(this.bankOptions);
            actualBankCode = keys[Math.floor(Math.random() * keys.length)];
          }

          const paddedBankCode = actualBankCode.toString().padStart(2, '0');

          let accountNumber = '';
          for (let i = 0; i < 18; i++) {
            accountNumber += Math.floor(Math.random() * 10);
          }

          const bban = paddedBankCode + accountNumber;
          const checkDigits = this.calculateCheckDigits('SA', bban);
          const iban = 'SA' + checkDigits + bban;

          const actualBankName = this.lang === 'en'
  ? this.bankOptions[actualBankCode].name
  : this.bankOptions[actualBankCode].ar;

          this.generatedIban = { iban, bank: actualBankName };

          this.animatedBankName = ''.padEnd(actualBankName.length, ' ');
          const nameTarget = actualBankName.split('');
          let j = 0;

          const nameInterval = setInterval(() => {
            if (j >= nameTarget.length) return clearInterval(nameInterval);

            let count = 0;
            const maxCycles = 4;
            const charIndex = j;

            const charInterval = setInterval(() => {
              if (count < maxCycles) {
                const randChar = String.fromCharCode(65 + Math.floor(Math.random() * 26));
                this.animatedBankName =
                  this.animatedBankName.substring(0, charIndex) +
                  randChar +
                  this.animatedBankName.substring(charIndex + 1);
                count++;
              } else {
                clearInterval(charInterval);
                this.animatedBankName =
                  this.animatedBankName.substring(0, charIndex) +
                  nameTarget[charIndex] +
                  this.animatedBankName.substring(charIndex + 1);
              }
            }, 30);

            j++;
          }, 50);

          // Animation logic: "SA" fixed, animate from 3rd char onward
          if (!this.animatedIban.length) {
            this.animatedIban = ['S', 'A', ...Array.from({ length: iban.length - 2 }, () => 'X')];
          }
          const target = iban.split('');
          let i = 2;

          const interval = setInterval(() => {
            if (i >= target.length) return clearInterval(interval);

            const slot = i;
            let count = 0;
            const maxCycles = 4;

            const slotInterval = setInterval(() => {
              if (count < maxCycles) {
                this.animatedIban[slot] = Math.floor(Math.random() * 10).toString();
                count++;
              } else {
                clearInterval(slotInterval);
                this.animatedIban[slot] = target[slot];
              }
            }, 40);

            i++;
          }, 50);

          this.ibanHistory.unshift({ iban, bank: actualBankName });
          this.ibanHistory = this.ibanHistory.slice(0, 7);
          localStorage.setItem('ibanHistory', JSON.stringify(this.ibanHistory));

          this.selectedBankCode = bankCode === 'random' ? '' : actualBankCode;
        },

        calculateCheckDigits(countryCode, bban) {
          const rearranged = bban + countryCode + '00';
          let converted = '';
          for (const ch of rearranged) {
            converted += isNaN(ch) ? (ch.toUpperCase().charCodeAt(0) - 55) : ch;
          }
          const mod97 = BigInt(converted) % 97n;
          return String(98n - mod97).padStart(2, '0');
        },

        copyIban() {
          const ibanText = (this.$refs.ibanText?.textContent || '').replace(/\s+/g, '');
          if (!ibanText) {
            this.showToastMessage(this.lang === 'en' ? 'Nothing to copy.' : 'لا يوجد ما يمكن نسخه.');
            return;
          }

          if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
            navigator.clipboard.writeText(ibanText)
              .then(() => {
                this.showToastMessage(this.lang === 'en' ? 'IBAN copied 📂!' : 'تم نسخ الآيبان 📂!');
                this.showCopiedTooltip = true;
                setTimeout(() => this.showCopiedTooltip = false, 1500);
              })
              .catch(() => this.showToastMessage(this.lang === 'en' ? 'Failed to copy IBAN.' : 'فشل في نسخ الآيبان.'));
          } else {
            // Fallback using older execCommand method
            const textarea = document.createElement('textarea');
            textarea.value = ibanText;
            textarea.setAttribute('readonly', '');
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            try {
              document.execCommand('copy');
              this.showToastMessage(this.lang === 'en' ? 'IBAN copied 📂!' : 'تم نسخ الآيبان 📂!');
              this.showCopiedTooltip = true;
              setTimeout(() => this.showCopiedTooltip = false, 1500);
            } catch (err) {
              this.showToastMessage(this.lang === 'en' ? 'Copy not supported.' : 'النسخ غير مدعوم.');
            }
            document.body.removeChild(textarea);
          }
        },

        clearHistory() {
          const fadeDuration = 300;
          const list = document.querySelectorAll('ul li');
          list.forEach((el, i) => {
            setTimeout(() => {
              el.style.transition = `opacity ${fadeDuration}ms ease`;
              el.style.opacity = '0';
            }, i * 50);
          });
          setTimeout(() => {
            this.ibanHistory = [];
            localStorage.removeItem('ibanHistory');
            this.showToastMessage(this.lang === 'en' ? 'History cleared 🗑️' : 'تم مسح السجل 🗑️');
          }, list.length * 50 + fadeDuration);
        },

        showToastMessage(msg) {
          this.toastMessage = msg;
          this.showToast = true;
          setTimeout(() => this.showToast = false, 2000);
        }     
        
      }
    }
  </script>
</body>
</html>
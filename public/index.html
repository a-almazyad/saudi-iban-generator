<!DOCTYPE html>
<html
  :dir="lang === 'ar' ? 'rtl' : 'ltr'"
  lang="en"
  class="transition-colors duration-300"
  x-data="ibanApp()"
  x-init="init(); $watch('darkMode', val => {
    document.documentElement.classList.toggle('dark', val);
    localStorage.setItem('darkMode', val);
    localStorage.setItem('darkModeSetAt', Date.now().toString()); // Timestamp update here
  })"
>
<head>
  <script>
    // Initial dark mode check (runs before Alpine)
    let savedPref = localStorage.getItem('darkMode');
    const expiryKey = 'darkModeSetAt';
    const now = Date.now();
    const maxAge = 24 * 60 * 60 * 1000; // 24 hours
    const lastSet = parseInt(localStorage.getItem(expiryKey), 10);
    if (!lastSet || now - lastSet > maxAge) {
      localStorage.removeItem('darkMode');
      localStorage.removeItem(expiryKey);
      savedPref = null;
    }
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (savedPref !== 'true' && savedPref !== 'false') {
      localStorage.removeItem('darkMode');
      savedPref = null;
    }
    const useDark = savedPref === 'true' ? true : savedPref === 'false' ? false : prefersDark;
    if (useDark) {
      document.documentElement.classList.add('dark');
    }
  </script>
  <meta charset="UTF-8" />
  <title>Saudi IBAN Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
    };
  </script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    @keyframes spinHalf {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(180deg); }
    }

    .animate-spin-half {
      animation: spinHalf 0.5s ease-in-out;
    }
    body::before {
      content: "";
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1;
      background: linear-gradient(-45deg, #e0f2f7, #f1f8e9, #fff3e0, #fce4ec); /* Lighter pastel */
      background-size: 400% 400%;
      animation: gradientShift 18s ease infinite;
      transition: opacity 0.5s;
    }
    .dark body::before {
      background: linear-gradient(-45deg, #0f172a, #1e293b, #334155, #475569); /* Darker blue/gray */
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    [x-cloak] { display: none !important; }
    /* Custom scrollbar for dropdown */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; }
    .custom-scrollbar { scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent; }
    .dark .custom-scrollbar { scrollbar-color: #4b5563 transparent; }

    /* Animation optimization for history list items */
    .history-list-item {
      will-change: opacity, transform;
    }

    .pulse-highlight {
      animation: pulseFade 1.5s ease-out;
    }

    @keyframes pulseFade {
      0% {
        box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.6); /* amber-400 */
      }
      50% {
        box-shadow: 0 0 0 8px rgba(250, 204, 21, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(250, 204, 21, 0);
      }
    }

    .dark .pulse-highlight {
      animation: pulseFadeDark 1.5s ease-out;
    }

    @keyframes pulseFadeDark {
      0% {
        box-shadow: 0 0 0 0 rgba(107, 114, 128, 0.4); /* gray-500 */
      }
      50% {
        box-shadow: 0 0 0 8px rgba(107, 114, 128, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(107, 114, 128, 0);
      }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-slate-900 dark:text-gray-100 flex flex-col items-center justify-center min-h-screen p-4 transition-colors duration-300">

  <!-- Toast -->
  <div
    x-show="showToast"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0 transform translate-y-2"
    x-transition:enter-end="opacity-100 transform translate-y-0"
    x-transition:leave="transition ease-in duration-300"
    x-transition:leave-start="opacity-100 transform translate-y-0"
    x-transition:leave-end="opacity-0 transform translate-y-2"
    class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-white text-black dark:bg-gray-700 dark:text-white px-5 py-3 rounded-lg shadow-lg ring-1 ring-gray-300 dark:ring-gray-600 z-50 text-sm font-medium flex items-center gap-2"
    x-cloak
  >
    <span x-text="toastMessage"></span>
    <span x-show="toastType === 'success'">‚úÖ</span>
    <span x-show="toastType === 'info'">‚ÑπÔ∏è</span>
    <span x-show="toastType === 'error'">‚ùå</span>
  </div>

  <!-- Controls Row -->
  <div class="fixed top-4 right-4 z-50 flex items-center gap-3">
     <button
      @click="toggleTheme()"
      class="w-10 h-10 flex items-center justify-center rounded-full border border-gray-300 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-900 transition transform hover:scale-110"
      :title="darkMode ? (lang === 'en' ? 'Switch to Light Mode' : 'ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ•ŸÑŸâ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÅÿßÿ™ÿ≠') : (lang === 'en' ? 'Switch to Dark Mode' : 'ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ•ŸÑŸâ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿØÿßŸÉŸÜ')"
    >
      <span x-show="!darkMode" class="text-xl">üåô</span>
      <span x-show="darkMode" class="text-xl" x-cloak>üåû</span> <!-- Added x-cloak here -->
    </button>
    <button
      @click="lang = lang === 'en' ? 'ar' : 'en'; localStorage.setItem('lang', lang)"
      class="w-10 h-10 flex items-center justify-center rounded-full border border-gray-300 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-900 transition transform hover:scale-110"
      :title="lang === 'en' ? 'ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ•ŸÑŸâ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©' : 'Switch to English'"
    >
      <span x-text="lang === 'en' ? 'üá∏üá¶' : 'üá¨üáß'" class="text-xl"></span>
    </button>
  </div>

  <!-- Main Content Area -->
  <div class="w-full max-w-md flex flex-col items-center space-y-8 pt-16 pb-8">

    <!-- Generator Card -->
    <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-md dark:text-white p-6 sm:p-8 rounded-2xl shadow-xl w-full text-center transition-all duration-300 flex flex-col">
      <div class="mb-6">
        <h1 class="text-2xl font-bold flex items-center justify-center gap-2 text-gray-900 dark:text-white"
            x-text="lang === 'en' ? 'üá∏üá¶ Saudi IBAN Generator' : 'ŸÖŸàŸÑÿØ ÿßŸÑÿ¢Ÿäÿ®ÿßŸÜ ÿßŸÑÿ≥ÿπŸàÿØŸä üá∏üá¶'">
        </h1>
         <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" x-text="lang === 'en' ? 'Generate valid-format Saudi IBANs' : 'ÿ™ŸàŸÑŸäÿØ ÿ¢Ÿäÿ®ÿßŸÜÿßÿ™ ÿ≥ÿπŸàÿØŸäÿ© ÿ®ÿ™ŸÜÿ≥ŸäŸÇ ÿµÿ≠Ÿäÿ≠'"></p>
      </div>

      <!-- IBAN Display Area -->
      <div
        class="mb-6 text-left min-h-[110px] flex flex-col justify-center p-4 rounded-lg transition-colors duration-300"
        :class="['transition-all', 'duration-500', 'rounded-lg']"
        :style="darkMode ? 'background-color: rgba(107,114,128,0.2)' : 'background-color: #fffde7'"
        data-iban-highlight
      >
        <div>
          <div class="flex justify-between items-start mb-1">
              <p class="text-xs sm:text-sm mb-1 font-semibold text-gray-600 dark:text-gray-300"
                 x-text="lang === 'en' ? 'Generated IBAN:' : 'ÿßŸÑÿ¢Ÿäÿ®ÿßŸÜ ÿßŸÑŸÖŸèŸàŸÑÿØ:'"
                 :class="lang === 'ar' ? 'text-right' : ''"></p>
              <!-- Compact Copy Button -->
              <button
                  @click="copyIban()"
                  :disabled="!generatedIban"
                  class="text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 disabled:opacity-50 disabled:cursor-not-allowed transition transform active:scale-95"
                  :title="lang === 'en' ? 'Copy IBAN' : 'ŸÜÿ≥ÿÆ ÿßŸÑÿ¢Ÿäÿ®ÿßŸÜ'">
                  <i data-feather="copy" class="w-[18px] h-[18px]"></i> <!-- Feather Icon -->
              </button>
          </div>
          <!-- IBAN Number -->
          <p class="text-blue-700 dark:text-blue-400 font-mono break-words text-lg md:text-xl min-h-[2rem] ltr:text-left rtl:text-left leading-tight"
             x-ref="ibanText"
             x-text="animatedIban.length ? animatedIban.map((c, i) => (i > 1 && (i - 2) % 4 === 0 ? ' ' + c : c)).join('') : 'SA XX XXXX XXXX XXXX XXXX XXXX'">
          </p>
          <!-- Bank Name -->
          <p class="text-xs text-gray-600 dark:text-gray-400 mt-2 min-h-[1rem]" :class="lang === 'ar' ? 'text-right' : ''">
            <span class="inline-flex items-center gap-1.5">
              <template x-if="generatedIban?.bank && bankOptions[selectedBankCode]">
                 <img :src="bankOptions[selectedBankCode]?.logo" alt="" class="w-3 h-3 inline-block" />
              </template>
              <span x-text="animatedBankName || (generatedIban?.bank || (lang === 'en' ? 'N/A' : 'ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠'))"></span>
            </span>
          </p>
        </div>
      </div>

      <!-- Bank Selector -->
      <div class="mb-6 text-left">
        <label class="text-sm font-semibold text-gray-700 dark:text-gray-300 block mb-1.5"
               x-text="lang === 'en' ? 'Choose a bank (optional):' : 'ÿßÿÆÿ™ÿ± ÿ®ŸÜŸÉŸãÿß (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä):'"
               :class="lang === 'ar' ? 'text-right' : ''"></label>
        <div class="relative" x-data="{ dropdownOpen: false }">
          <button @click="dropdownOpen = !dropdownOpen" type="button"
               class="w-full cursor-pointer bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2.5 text-sm flex items-center justify-between hover:border-gray-400 dark:hover:border-gray-500 transition">
            <div class="flex items-center gap-2">
              <template x-if="selectedBankCode && bankOptions[selectedBankCode]">
                <img :src="bankOptions[selectedBankCode].logo" alt="Logo" class="w-5 h-5" />
              </template>
              <template x-if="!selectedBankCode">
                <span class="text-lg">üé≤</span>
              </template>
              <span x-text="selectedBankCode ? (lang === 'en' ? bankOptions[selectedBankCode].name : bankOptions[selectedBankCode].ar) : (lang === 'en' ? 'Random Bank' : 'ÿ®ŸÜŸÉ ÿπÿ¥Ÿàÿßÿ¶Ÿä')"></span>
            </div>
             <i data-feather="chevron-down" class="w-4 h-4 ml-2 text-gray-500 dark:text-gray-400 transition-transform duration-200" :class="{ 'rotate-180': dropdownOpen }"></i> <!-- Feather Icon -->
          </button>
          <div x-show="dropdownOpen" @click.outside="dropdownOpen = false"
               x-transition:enter="transition ease-out duration-100"
               x-transition:enter-start="opacity-0 scale-95"
               x-transition:enter-end="opacity-100 scale-100"
               x-transition:leave="transition ease-in duration-75"
               x-transition:leave-start="opacity-100 scale-100"
               x-transition:leave-end="opacity-0 scale-95"
               class="absolute z-20 mt-1 w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg max-h-60 overflow-y-auto custom-scrollbar"
               x-cloak>
            <div @click="selectedBankCode = ''; dropdownOpen = false"
                 class="flex items-center px-4 py-2.5 text-sm hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer gap-2">
              <span class="text-lg">üé≤</span>
              <span x-text="lang === 'en' ? 'Random Bank' : 'ÿ®ŸÜŸÉ ÿπÿ¥Ÿàÿßÿ¶Ÿä'"></span>
            </div>
            <template x-for="(bank, code) in bankOptions" :key="code">
              <div @click="selectedBankCode = code; dropdownOpen = false"
                   class="flex items-center px-4 py-2.5 text-sm hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer">
                <img :src="bank.logo" alt="" class="w-5 h-5 flex-shrink-0" :class="lang === 'ar' ? 'ml-3' : 'mr-3'" />
                <span x-text="lang === 'en' ? bank.name : bank.ar"></span>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Generate Button -->
      <button
      @click="generateIban()"
      type="button"
      class="w-full text-base bg-gradient-to-r from-green-500 to-emerald-600 dark:from-green-600 dark:to-emerald-700 text-white px-6 py-3 rounded-full relative transition-all duration-300 font-semibold flex items-center justify-center gap-2 hover:ring-4 hover:ring-green-300/40 dark:hover:ring-green-500/30 hover:scale-100"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw" :class="{ 'animate-spin-half': generating }"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
      <span x-text="lang === 'en' ? 'Generate IBAN' : 'ÿ™ŸàŸÑŸäÿØ ÿ¢Ÿäÿ®ÿßŸÜ'"></span>
    </button>
    </div>

    <!-- History Section -->
    <div class="w-full max-w-md text-left mt-8 px-2">
       <div class="flex justify-between items-center mb-3">
         <h2 class="text-base font-semibold text-gray-700 dark:text-gray-300" x-text="lang === 'en' ? 'Recent IBANs:' : 'ÿßŸÑÿ¢Ÿäÿ®ÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿÆŸäÿ±ÿ©:'"></h2>
          <button
            @click="ibanHistory.length && clearHistory()"
            :class="ibanHistory.length ? 'text-red-500 hover:text-red-700 dark:hover:text-red-400 cursor-pointer' : 'text-gray-400 dark:text-gray-500 cursor-not-allowed'"
            class="text-xs font-medium transition flex items-center gap-1 disabled:opacity-70"
            :disabled="!ibanHistory.length"
            :title="lang === 'en' ? 'Clear History' : 'ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ'">
             <i data-feather="trash-2" class="w-3.5 h-3.5"></i> <!-- Feather Icon -->
            <span x-text="lang === 'en' ? 'Clear' : 'ŸÖÿ≥ÿ≠'"></span>
          </button>
       </div>
      <div class="min-h-[180px]">
        <template x-if="ibanHistory.length">
          <ul class="text-xs sm:text-sm space-y-1.5">
            <template x-for="(item, index) in ibanHistory" :key="item.iban + index">
              <li
                class="history-list-item p-3 rounded-md transition duration-200 ease-in-out flex flex-col sm:flex-row sm:items-center sm:justify-between gap-x-2 gap-y-1"
                :class="{
                  'bg-white/60 dark:bg-gray-800/60 shadow-sm': index === 0,
                  'bg-white/40 dark:bg-gray-800/40': index > 0 && index % 2 !== 0,
                  'bg-white/30 dark:bg-gray-800/30': index > 0 && index % 2 === 0,
                  'opacity-100': index < 3, 'opacity-80': index === 3, 'opacity-70': index === 4,
                  'opacity-60': index === 5, 'opacity-50': index === 6,
                }"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform -translate-y-2"
                x-transition:enter-end="opacity-100 transform translate-y-0"
               >
                <span
                  class="font-mono break-words leading-snug text-gray-800 dark:text-gray-200"
                  x-text="item.iban.replace(/(SA\d{2})(\d{4})(\d{4})(\d{4})(\d{4})(\d{4})/, '$1 $2 $3 $4 $5 $6')"
                ></span>
                 <div class="flex items-center min-w-0 gap-1.5 flex-shrink-0" :class="lang === 'ar' ? 'sm:mr-auto' : 'sm:ml-auto'">
                    <!-- Find logo using the stored English name -->
                    <template x-if="Object.values(bankOptions).find(b => b.name === item.bank)">
                      <img
                        :src="Object.values(bankOptions).find(b => b.name === item.bank)?.logo"
                        alt=""
                        class="w-4 h-4 flex-shrink-0"
                      />
                    </template>
                    <span
                      x-text="lang === 'en' ? item.bank : (Object.values(bankOptions).find(b => b.name === item.bank)?.ar || item.bank)"
                      class="truncate text-gray-600 dark:text-gray-400 text-xs"
                      :title="item.bank"
                      style="max-width: 150px;"
                    ></span>
                  </div>
              </li>
            </template>
          </ul>
        </template>
        <template x-if="!ibanHistory.length">
          <p class="text-sm text-center text-gray-500 dark:text-gray-400 pt-10 pb-4" x-text="lang === 'en' ? 'No recent IBANs.' : 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ¢Ÿäÿ®ÿßŸÜÿßÿ™ ÿ≠ÿØŸäÿ´ÿ©.'"></p>
        </template>
      </div>
    </div>

  </div>

  <!-- Footer -->
  <footer class="fixed bottom-4 left-4 z-50">
    <a href="https://github.com/a-almazyad/saudi-iban-generator" target="_blank" rel="noopener noreferrer" class="text-xs text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 font-medium">
      GitHub Project
    </a>
  </footer>

  <!-- AlpineJS Logic -->
  <script>
    function ibanApp() {
      return {
        generating: false,
        lang: localStorage.getItem('lang') || 'en',
        generatedIban: null, // Structure: { iban: 'SA...', bank: 'Displayed Bank Name' }
        ibanHistory: [], // Structure: [{ iban: 'SA...', bank: 'English Bank Name' }, ...]
        selectedBankCode: '', // e.g., '10', '80', '' for random
        animatedIban: [],
        animatedBankName: '',
        bankOptions: {
          '5':  { name: 'Alinma Bank', ar: 'ŸÖÿµÿ±ŸÅ ÿßŸÑÿ•ŸÜŸÖÿßÿ°', logo: 'logos/alinma.png' },
          '10': { name: 'SNB', ar: 'ÿßŸÑÿ®ŸÜŸÉ ÿßŸÑÿ£ŸáŸÑŸä ÿßŸÑÿ≥ÿπŸàÿØŸä', logo: 'logos/snb.png' },
          '15': { name: 'Bank Albilad', ar: 'ÿ®ŸÜŸÉ ÿßŸÑÿ®ŸÑÿßÿØ', logo: 'logos/bilad.png' },
          '20': { name: 'Riyad Bank', ar: 'ÿ®ŸÜŸÉ ÿßŸÑÿ±Ÿäÿßÿ∂', logo: 'logos/riyad.png' },
          '30': { name: 'Arab National Bank', ar: 'ÿßŸÑÿ®ŸÜŸÉ ÿßŸÑÿπÿ±ÿ®Ÿä ÿßŸÑŸàÿ∑ŸÜŸä', logo: 'logos/anb.png' },
          '36': { name: 'D360 Bank', ar: 'ÿ®ŸÜŸÉ ÿØŸäŸ£Ÿ¶Ÿ†', logo: 'logos/d360.png' },
          '45': { name: 'SABB', ar: 'ÿ≥ÿßÿ®', logo: 'logos/sabb.png' },
          '55': { name: 'BSF', ar: 'ÿßŸÑÿ®ŸÜŸÉ ÿßŸÑÿ≥ÿπŸàÿØŸä ÿßŸÑŸÅÿ±ŸÜÿ≥Ÿä', logo: 'logos/fransi.png' },
          '60': { name: 'Bank AlJazira', ar: 'ÿ®ŸÜŸÉ ÿßŸÑÿ¨ÿ≤Ÿäÿ±ÿ©', logo: 'logos/jazira.png' },
          '65': { name: 'Investment Bank', ar: 'ÿßŸÑÿ®ŸÜŸÉ ÿßŸÑÿ≥ÿπŸàÿØŸä ŸÑŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±', logo: 'logos/saib.png' },
          '78': { name: 'STC Bank', ar: 'ÿ®ŸÜŸÉ ÿ•ÿ≥ ÿ™Ÿä ÿ≥Ÿä', logo: 'logos/stc.png' },
          '80': { name: 'Al Rajhi Bank', ar: 'ŸÖÿµÿ±ŸÅ ÿßŸÑÿ±ÿßÿ¨ÿ≠Ÿä', logo: 'logos/rajhi.png' }
        },
        showToast: false,
        toastMessage: '',
        toastType: 'info', // 'success', 'error', 'info'
        darkMode: false, // Will be properly set by init()
        toastTimeout: null, // To manage the toast timer

        init() {
          // --- Language Initialization ---
          this.lang = localStorage.getItem('lang') || 'en';

          // --- History Initialization ---
          this.loadHistory();

          // --- Icons Initialization ---
          this.$nextTick(() => {
            feather.replace(); // Initialize icons after Alpine is ready
          });

          // System preference listener (only if no user preference is set)
          if (localStorage.getItem('darkMode') === null) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
              document.documentElement.classList.toggle('dark', e.matches);
            });
          }

          // Cleanup intervals when the component is destroyed
          this.$watch('$el', (el, oldEl) => {
            if (!el) {
              if (window.animatedBankNameInterval) clearInterval(window.animatedBankNameInterval);
              if (window.animatedIbanInterval) clearInterval(window.animatedIbanInterval);
            }
          });
        },

        // Toggles the state, watcher handles the rest
        toggleTheme() {
          this.darkMode = !this.darkMode;
        },

        loadHistory() {
          try {
            const storedHistory = JSON.parse(localStorage.getItem('ibanHistory') || '[]');
            if (Array.isArray(storedHistory) && storedHistory.every(item => typeof item === 'object' && item !== null && item.iban && item.bank)) {
              this.ibanHistory = storedHistory;
            } else {
              this.ibanHistory = [];
              localStorage.removeItem('ibanHistory');
            }
          } catch (e) {
            this.ibanHistory = [];
            localStorage.removeItem('ibanHistory');
          }
        },

        generateIban() {
          this.generating = true;
          setTimeout(() => { this.generating = false; }, 1000);
          const bankCode = this.selectedBankCode || 'random';
          let actualBankCode = bankCode;

          if (bankCode === 'random') {
            const keys = Object.keys(this.bankOptions);
            actualBankCode = keys[Math.floor(Math.random() * keys.length)];
          } else {
            actualBankCode = this.selectedBankCode;
          }

          if (!this.bankOptions[actualBankCode]) {
            // console.error(`Invalid bank code selected or generated: ${actualBankCode}`);
            this.showToastMessage(this.lang === 'en' ? 'Error: Invalid bank.' : 'ÿÆÿ∑ÿ£: ÿ®ŸÜŸÉ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠.', 'error');
            return;
          }

          const bankInfo = this.bankOptions[actualBankCode];
          const paddedBankCode = actualBankCode.toString().padStart(2, '0');
          let accountNumber = '';
          for (let i = 0; i < 18; i++) {
            accountNumber += Math.floor(Math.random() * 10);
          }
          const bban = paddedBankCode + accountNumber;
          const checkDigits = this.calculateCheckDigits('SA', bban);

          if (checkDigits === 'XX') { // Handle calculation error
            this.showToastMessage(this.lang === 'en' ? 'Error generating IBAN.' : 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ¢Ÿäÿ®ÿßŸÜ.', 'error');
            return;
          }

          const iban = 'SA' + checkDigits + bban;
          const actualBankName = this.lang === 'en' ? bankInfo.name : bankInfo.ar;
          const storedBankName = bankInfo.name; // Store English name for history consistency

          this.generatedIban = { iban, bank: actualBankName }; // For display

          // Pulse animation
          this.$nextTick(() => {
            const ibanBox = document.querySelector('[data-iban-highlight]');
            if (ibanBox) {
              ibanBox.classList.remove('pulse-highlight');
              void ibanBox.offsetWidth; // Force reflow
              ibanBox.classList.add('pulse-highlight');
            }
          });

          this.animateText('animatedBankName', actualBankName, 30, 40);
          this.animateIban('animatedIban', iban, 40, 50);

          // Prevent duplicates and update history
          if (!this.ibanHistory.some(item => item.iban === iban)) {
            this.ibanHistory.unshift({ iban, bank: storedBankName });
            this.ibanHistory = this.ibanHistory.slice(0, 7);
            localStorage.setItem('ibanHistory', JSON.stringify(this.ibanHistory));
          }

          // Update dropdown to reflect the actual bank, unless user selected "Random Bank"
          // console.log(`[Generate] Generated IBAN for ${storedBankName}: ${iban}`);
        },

        // Reusable Text Scramble Animation
        animateText(propName, targetText, charIntervalSpeed, slotIntervalSpeed) {
            this[propName] = ''; // Clear current text
            const targetChars = targetText.split('');
            let currentChars = Array(targetChars.length).fill(' ');
            let charIndex = 0;
            let intervalId = null;

            if (window[`${propName}Interval`]) clearInterval(window[`${propName}Interval`]);

            intervalId = setInterval(() => {
                if (charIndex >= targetChars.length) {
                    clearInterval(intervalId);
                    window[`${propName}Interval`] = null;
                    this[propName] = targetText;
                    return;
                }
                const currentSlot = charIndex;
                let cycleCount = 0;
                const maxCycles = 3;
                let charIntervalId = null;

                charIntervalId = setInterval(() => {
                    if (cycleCount >= maxCycles) {
                        clearInterval(charIntervalId);
                        currentChars[currentSlot] = targetChars[currentSlot];
                        this[propName] = currentChars.join('');
                    } else {
                        const randomChar = String.fromCharCode(33 + Math.random() * 94); // Visible ASCII
                        currentChars[currentSlot] = randomChar;
                        this[propName] = currentChars.join('');
                        cycleCount++;
                    }
                }, charIntervalSpeed);
                charIndex++;
            }, slotIntervalSpeed);
             window[`${propName}Interval`] = intervalId;
        },

        // Specific IBAN Animation (starts from 3rd char)
        animateIban(propName, targetIban, charIntervalSpeed, slotIntervalSpeed) {
            const targetChars = targetIban.split('');
            if (!this[propName] || this[propName].length !== targetChars.length) {
                 this[propName] = ['S', 'A', ...Array(targetChars.length - 2).fill('X')];
            }
            let currentChars = [...this[propName]];
            let charIndex = 2;
            let intervalId = null;

            if (window[`${propName}Interval`]) clearInterval(window[`${propName}Interval`]);

            intervalId = setInterval(() => {
                if (charIndex >= targetChars.length) {
                    clearInterval(intervalId);
                    window[`${propName}Interval`] = null;
                    this[propName] = [...targetChars]; // Final state raw characters
                    return;
                }
                const currentSlot = charIndex;
                let cycleCount = 0;
                const maxCycles = 4;
                let charIntervalId = null;

                charIntervalId = setInterval(() => {
                    if (cycleCount >= maxCycles) {
                        clearInterval(charIntervalId);
                        currentChars[currentSlot] = targetChars[currentSlot];
                        this[propName] = [...currentChars];
                    } else {
                        currentChars[currentSlot] = Math.floor(Math.random() * 10).toString();
                        this[propName] = [...currentChars];
                        cycleCount++;
                    }
                }, charIntervalSpeed);
                charIndex++;
            }, slotIntervalSpeed);
             window[`${propName}Interval`] = intervalId;
        },

        // Calculates ISO 7064 MOD 97-10 check digits
        calculateCheckDigits(countryCode, bban) {
          const rearranged = bban + countryCode + '00';
          let converted = '';
          for (const ch of rearranged) {
            // Convert A-Z to 10-35
            converted += isNaN(ch) ? (ch.toUpperCase().charCodeAt(0) - 55).toString() : ch;
          }

          // Use chunking for large numbers to avoid BigInt issues in some environments
          try {
            let remainder = 0;
            const chunkSize = 9; // Process in chunks smaller than max safe integer digits
            for (let i = 0; i < converted.length; i += chunkSize) {
              const chunk = converted.slice(i, i + chunkSize);
              remainder = parseInt(remainder.toString() + chunk, 10) % 97;
            }
            const checkDigitValue = 98 - remainder;
            return checkDigitValue.toString().padStart(2, '0');
          } catch (e) {
            try {
              const mod97 = BigInt(converted) % 97n;
              return String(98n - mod97).padStart(2, '0');
            } catch (bigIntError) {
              return 'XX'; // Indicate error
            }
          }
        },

        copyIban() {
          const ibanToCopy = this.generatedIban?.iban;
          if (!ibanToCopy) {
            this.showToastMessage(this.lang === 'en' ? 'Generate an IBAN first.' : 'ŸÇŸÖ ÿ®ÿ™ŸàŸÑŸäÿØ ÿ¢Ÿäÿ®ÿßŸÜ ÿ£ŸàŸÑÿßŸã.', 'info');
            return;
          }

          if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
            navigator.clipboard.writeText(ibanToCopy)
              .then(() => {
                this.showToastMessage(this.lang === 'en' ? 'IBAN copied!' : '!ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ¢Ÿäÿ®ÿßŸÜ', 'success');
              })
              .catch(() => {
                this.fallbackCopy(ibanToCopy);
              });
          } else {
            this.fallbackCopy(ibanToCopy);
          }
        },

        fallbackCopy(text) {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.setAttribute('readonly', '');
          textarea.style.position = 'absolute';
          textarea.style.left = '-9999px';
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand('copy');
            this.showToastMessage(this.lang === 'en' ? 'IBAN copied!' : '!ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ¢Ÿäÿ®ÿßŸÜ', 'success');
          } catch {
            this.showToastMessage(this.lang === 'en' ? 'Failed to copy.' : '.ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ≥ÿÆ', 'error');
          }
          document.body.removeChild(textarea);
        },

        clearHistory() {
          const listItems = document.querySelectorAll('.history-list-item');
          if (this.ibanHistory.length === 0) {
            this.showToastMessage(this.lang === 'en' ? 'History is already empty' : 'ÿßŸÑÿ≥ÿ¨ŸÑ ŸÅÿßÿ±ÿ∫ ÿ®ÿßŸÑŸÅÿπŸÑ', 'info');
            return;
          }

          // Animate out existing items using requestAnimationFrame for accuracy
          listItems.forEach((el, i) => {
            el.style.willChange = 'opacity, transform';
            // Use requestAnimationFrame to ensure layout is up-to-date before applying styles
            requestAnimationFrame(() => {
              el.style.transition = `opacity 0.3s ease ${i * 0.03}s, transform 0.3s ease ${i * 0.03}s`;
              el.style.opacity = '0';
              el.style.transform = 'translateY(10px)';
            });
          });

          // Wait for animation to finish before clearing data and showing toast
          setTimeout(() => {
            this.ibanHistory = [];
            localStorage.removeItem('ibanHistory');
            this.showToastMessage(this.lang === 'en' ? 'History cleared' : 'ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ', 'success');
          }, listItems.length * 30 + 300);
        },

        showToastMessage(msg, type = 'info') {
            this.toastMessage = msg;
            this.toastType = type;
            this.showToast = true;
            if (this.toastTimeout) clearTimeout(this.toastTimeout); // Clear existing timer
            this.toastTimeout = setTimeout(() => this.showToast = false, 2500);
        }

      }
    }
  </script>
</body>
</html>
<!DOCTYPE html>
<html
  :dir="lang === 'ar' ? 'rtl' : 'ltr'"
  :lang="lang"
  class="transition-colors duration-300"
  x-data="ibanApp()"
  x-init="init(); $watch('darkMode', val => {
    document.documentElement.classList.toggle('dark', val);
    if (manualToggle) {
      localStorage.setItem('darkMode', val);
    }
  })"
>
<head>
    <script>
      (() => {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const manualOverride = localStorage.getItem('darkMode');
        let useDark;
        if (manualOverride === 'true' || manualOverride === 'false') {
          useDark = manualOverride === 'true';
        } else {
          useDark = prefersDark;
        }
        document.documentElement.classList.toggle('dark', useDark);
      })();

      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        const manualOverride = localStorage.getItem('darkMode');
        if (manualOverride !== 'true' && manualOverride !== 'false') {
          const prefersDarkNow = e.matches;
          document.documentElement.classList.toggle('dark', prefersDarkNow);
          const rootScope = document.querySelector('[x-data]');
          if (rootScope && rootScope.__x && rootScope.__x.$data) {
            rootScope.__x.$data.darkMode = prefersDarkNow;
            rootScope.__x.$data.manualToggle = false;
          }
        }
      });
    </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Saudi IBAN Generator</title>
  <script src="https://cdn.tailwindcss.com/3.4.1"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
    };
  </script>
  <script src="https://unpkg.com/alpinejs@3.13.10/dist/cdn.min.js" defer></script>
  <script src="creditCard.js"></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>üá∏üá¶</text></svg>">
  <style>
    @keyframes spinHalf { 0% { transform: rotate(0deg); } 100% { transform: rotate(180deg); } }
    .animate-spin-half { animation: spinHalf 0.5s ease-in-out; }

    body::before {
      content: ""; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1;
      background: linear-gradient(-45deg, #e0f2f7, #f1f8e9, #fff3e0, #fce4ec);
      background-size: 400% 400%; animation: gradientShift 18s ease infinite; transition: background 0.5s;
    }
    .dark body::before {
      background: linear-gradient(-45deg, #0f172a, #1e293b, #3b0764, #0c4a6e, #334155);
      background-size: 400% 400%; animation: gradientShift 50s ease infinite;
    }
    @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    [x-cloak] { display: none !important; }

    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; }
    .custom-scrollbar { scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent; }
    .dark .custom-scrollbar { scrollbar-color: #4b5563 transparent; }

    .pulse-highlight { animation: pulseFade 1.5s ease-out; }
    @keyframes pulseFade {
      0% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.6); }
      70% { box-shadow: 0 0 0 8px rgba(250, 204, 21, 0); }
      100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0); }
    }
    .dark .pulse-highlight { animation: pulseFadeDark 1.5s ease-out; }
    @keyframes pulseFadeDark {
      0% { box-shadow: 0 0 0 0 rgba(107, 114, 128, 0.4); }
      70% { box-shadow: 0 0 0 8px rgba(107, 114, 128, 0); }
      100% { box-shadow: 0 0 0 0 rgba(107, 114, 128, 0); }
    }

    .history-list-item { will-change: opacity, transform; }
    .iban-text { font-size: 0.90rem; line-height: 1.4; }
    @media (min-width: 640px) {
      .iban-text { font-size: 0.93rem; }
    }
    .force-ltr { direction: ltr !important; text-align: left !important; }
  </style>
</head>
<body class="bg-transparent text-gray-800 dark:text-gray-100 flex flex-col items-center min-h-screen p-4 transition-colors duration-300">

  <div
    x-show="showToast"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0 transform translate-y-2"
    x-transition:enter-end="opacity-100 transform translate-y-0"
    x-transition:leave="transition ease-in duration-300"
    x-transition:leave-start="opacity-100 transform translate-y-0"
    x-transition:leave-end="opacity-0 transform translate-y-2"
    class="fixed top-6 left-1/2 transform -translate-x-1/2 max-w-[90%] bg-white text-black dark:bg-gray-700 dark:text-white px-5 py-3 rounded-lg shadow-lg ring-1 ring-gray-300 dark:ring-gray-600 z-50 text-sm font-medium flex items-center gap-2"
    x-cloak
    role="alert"
    aria-live="polite"
  >
    <span x-text="toastMessage"></span>
    <span x-show="toastType === 'success'" aria-hidden="true">‚úÖ</span>
    <span x-show="toastType === 'info'" aria-hidden="true">‚ÑπÔ∏è</span>
    <span x-show="toastType === 'error'" aria-hidden="true">‚ùå</span>
  </div>

  <div class="fixed top-4 right-4 z-30 flex items-center gap-3">
     <button
      @click="toggleTheme()"
      @keydown.enter.prevent="toggleTheme()"
      @keydown.space.prevent="toggleTheme()"
      type="button"
      class="w-10 h-10 flex items-center justify-center rounded-full border border-gray-300 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-900 transition transform hover:scale-110"
      :aria-label="darkMode ? (lang === 'en' ? 'Switch to Light Mode' : 'ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ•ŸÑŸâ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÅÿßÿ™ÿ≠') : (lang === 'en' ? 'Switch to Dark Mode' : 'ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ•ŸÑŸâ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿØÿßŸÉŸÜ')"
      :title="darkMode ? (lang === 'en' ? 'Switch to Light Mode' : 'ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ•ŸÑŸâ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÅÿßÿ™ÿ≠') : (lang === 'en' ? 'Switch to Dark Mode' : 'ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ•ŸÑŸâ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿØÿßŸÉŸÜ')"
    >
      <span x-show="!darkMode" class="text-xl" aria-hidden="true">üåô</span>
      <span x-show="darkMode" class="text-xl" x-cloak aria-hidden="true">üåû</span>
    </button>
    <button
      @click="lang = lang === 'en' ? 'ar' : 'en'; localStorage.setItem('lang', lang)"
      @keydown.enter.prevent="lang = lang === 'en' ? 'ar' : 'en'; localStorage.setItem('lang', lang)"
      @keydown.space.prevent="lang = lang === 'en' ? 'ar' : 'en'; localStorage.setItem('lang', lang)"
      type="button"
      class="w-10 h-10 flex items-center justify-center rounded-full border border-gray-300 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-900 transition transform hover:scale-110"
      :aria-label="lang === 'en' ? 'ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ•ŸÑŸâ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©' : 'Switch to English'"
      :title="lang === 'en' ? 'ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ•ŸÑŸâ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©' : 'Switch to English'"
    >
      <span x-text="lang === 'en' ? 'üá∏üá¶' : 'üá¨üáß'" class="text-xl" aria-hidden="true"></span>
    </button>
  </div>

  <main class="w-full max-w-md flex flex-col items-center space-y-8 pt-16 pb-24 px-2 sm:px-0">

    <div class="mb-4 flex w-full" :class="lang === 'ar' ? 'flex-row-reverse space-x-reverse space-x-2' : 'space-x-2'" role="tablist">
      <button @click="activeTab='iban'" :class="activeTab==='iban' ? 'bg-blue-600 text-white' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300'" class="flex-1 py-2 rounded-full text-sm font-medium focus:outline-none">
        <span x-text="lang === 'en' ? 'IBAN Generator' : 'ŸÖŸàŸÑÿØ ÿßŸÑÿ¢Ÿäÿ®ÿßŸÜ'"></span>
      </button>
      <button @click="activeTab='card'" :class="activeTab==='card' ? 'bg-blue-600 text-white' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300'" class="flex-1 py-2 rounded-full text-sm font-medium focus:outline-none">
        <span x-text="lang === 'en' ? 'Credit Card Generator' : 'ŸÖŸàŸÑÿØ ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™'"></span>
      </button>
    </div>

    <section x-show="activeTab==='iban'" aria-labelledby="generator-heading" class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-md dark:text-white p-6 sm:p-8 rounded-2xl shadow-xl w-full text-center transition-all duration-300 flex flex-col" x-cloak>
      <div class="mb-6">
        <h1 id="generator-heading" class="text-2xl font-bold flex items-center justify-center gap-2 text-gray-900 dark:text-white"
            x-text="lang === 'en' ? 'üá∏üá¶ Saudi IBAN Generator' : 'ŸÖŸàŸÑÿØ ÿßŸÑÿ¢Ÿäÿ®ÿßŸÜ ÿßŸÑÿ≥ÿπŸàÿØŸä üá∏üá¶'">
        </h1>
         <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" x-text="lang === 'en' ? 'Generate valid-format Saudi IBANs' : 'ÿ™ŸàŸÑŸäÿØ ÿ¢Ÿäÿ®ÿßŸÜÿßÿ™ ÿ≥ÿπŸàÿØŸäÿ© ÿ®ÿ™ŸÜÿ≥ŸäŸÇ ÿµÿ≠Ÿäÿ≠'"></p>
      </div>

      <div
        class="mb-6 text-left min-h-[110px] flex flex-col justify-center p-4 rounded-lg transition-colors duration-300 overflow-hidden"
        :class="['transition-all', 'duration-500', 'rounded-lg']"
        :style="darkMode ? 'background-color: rgba(107,114,128,0.2)' : 'background-color: #fffde7'"
        data-iban-highlight
      >
        <div>
          <div class="flex justify-between items-start mb-1 gap-2">
              <p class="text-xs sm:text-sm font-semibold text-gray-600 dark:text-gray-300 flex-grow"
                 x-text="lang === 'en' ? 'Generated IBAN' : 'ÿßŸÑÿ¢Ÿäÿ®ÿßŸÜ ÿßŸÑŸÖŸèŸàŸÑÿØ'"
                 :class="lang === 'ar' ? 'text-right' : 'text-left'"></p>
              <button
                  @click="copyIban()"
                  :disabled="!generatedIban"
                  type="button"
                  class="text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 disabled:opacity-50 disabled:cursor-not-allowed transition transform active:scale-95 flex-shrink-0"
                  :aria-label="lang === 'en' ? 'Copy IBAN' : 'ŸÜÿ≥ÿÆ ÿßŸÑÿ¢Ÿäÿ®ÿßŸÜ'"
                  :title="lang === 'en' ? 'Copy IBAN' : 'ŸÜÿ≥ÿÆ ÿßŸÑÿ¢Ÿäÿ®ÿßŸÜ'">
                  <svg class="w-[18px] h-[18px]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
              </button>
          </div>
          <p class="text-blue-700 dark:text-blue-400 font-mono break-words text-lg md:text-xl min-h-[2rem] leading-tight force-ltr"
             x-ref="ibanText"
             x-text="animatedIban.length ? formatIban(animatedIban.join('')) : 'SA XX XXXX XXXX XXXX XXXX XXXX'">
          </p>
          <p class="text-xs text-gray-600 dark:text-gray-400 mt-2 min-h-[1rem] flex items-center gap-1.5"
             :class="lang === 'ar' ? 'justify-start flex-row-reverse text-right' : 'justify-start text-left'">
              <template x-if="generatedIban?.bankCode && bankOptions[generatedIban.bankCode]">
                 <img :src="bankOptions[generatedIban.bankCode]?.logo" :alt="lang === 'en' ? bankOptions[generatedIban.bankCode].name + ' logo' : 'ÿ¥ÿπÿßÿ± ' + bankOptions[generatedIban.bankCode].ar" class="w-3 h-3 inline-block object-contain flex-shrink-0" />
              </template>
              <span class="truncate" :class="lang === 'ar' ? 'text-left w-full text-sm text-gray-600 dark:text-gray-400' : 'text-sm text-gray-600 dark:text-gray-400'" x-text="animatedBankName || (generatedIban?.bank || (lang === 'en' ? 'N/A' : 'ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠'))"></span>
          </p>
        </div>
      </div>

      <div class="mb-6 text-left">
        <label id="bank-select-label" class="text-sm font-semibold text-gray-700 dark:text-gray-300 block mb-1.5"
               x-text="lang === 'en' ? 'Choose a bank (optional)' : 'ÿßÿÆÿ™ÿ± ÿ®ŸÜŸÉŸãÿß (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)'"
               :class="lang === 'ar' ? 'text-right' : ''"></label>
        <div class="relative" x-data="{ dropdownOpen: false }">
          <button @click="dropdownOpen = !dropdownOpen" type="button"
               aria-haspopup="listbox"
               :aria-expanded="dropdownOpen.toString()"
               aria-controls="bank-dropdown-list"
               aria-labelledby="bank-select-label"
               class="w-full cursor-pointer bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2.5 text-sm flex items-center justify-between hover:border-gray-400 dark:hover:border-gray-500 transition">
            <span class="flex items-center gap-2 overflow-hidden flex-grow min-w-0">
              <template x-if="computedBank()">
                <img :src="computedBank().logo" :alt="lang === 'en' ? computedBank().name + ' logo' : 'ÿ¥ÿπÿßÿ± ' + computedBank().ar" class="w-5 h-5 flex-shrink-0 object-contain" />
              </template>
              <template x-if="!selectedBankCode">
                <span class="text-lg flex-shrink-0" aria-hidden="true">üé≤</span>
              </template>
              <span class="truncate" x-text="computedBank() ? (lang === 'en' ? computedBank().name : computedBank().ar) : (lang === 'en' ? 'Random Bank' : 'ÿ®ŸÜŸÉ ÿπÿ¥Ÿàÿßÿ¶Ÿä')"></span>
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-200 flex-shrink-0 ml-2" :class="{ 'rotate-180': dropdownOpen }" aria-hidden="true"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div x-show="dropdownOpen" @click.outside="dropdownOpen = false"
               x-transition:enter="transition ease-out duration-100"
               x-transition:enter-start="opacity-0 scale-95"
               x-transition:enter-end="opacity-100 scale-100"
               x-transition:leave="transition ease-in duration-75"
               x-transition:leave-start="opacity-100 scale-100"
               x-transition:leave-end="opacity-0 scale-95"
               class="absolute z-20 mt-1 w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg max-h-60 overflow-y-auto custom-scrollbar focus:outline-none"
               id="bank-dropdown-list"
               role="listbox"
               :aria-labelledby="bank-select-label"
               tabindex="-1"
               x-cloak>
            <div @click="selectedBankCode = ''; dropdownOpen = false; $event.target.closest('button').focus()"
                 role="option"
                 :aria-selected="selectedBankCode === ''"
                 :class="{ 'bg-blue-50 dark:bg-blue-900/50': selectedBankCode === '' }"
                 tabindex="0" @keydown.enter.prevent.stop="selectedBankCode = ''; dropdownOpen = false; $event.target.closest('button').focus()" @keydown.space.prevent.stop="selectedBankCode = ''; dropdownOpen = false; $event.target.closest('button').focus()"
                 class="flex items-center px-4 py-2.5 text-sm hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer gap-2 focus:outline-none focus:bg-gray-100 dark:focus:bg-gray-600">
              <span class="text-lg" aria-hidden="true">üé≤</span>
              <span x-text="lang === 'en' ? 'Random Bank' : 'ÿ®ŸÜŸÉ ÿπÿ¥Ÿàÿßÿ¶Ÿä'"></span>
            </div>
            <template x-for="(bank, code) in bankOptions" :key="code">
              <div @click="selectedBankCode = code; dropdownOpen = false; $event.target.closest('button').focus()"
                   role="option"
                   :aria-selected="selectedBankCode === code"
                   :class="{ 'bg-blue-50 dark:bg-blue-900/50': selectedBankCode === code }"
                   tabindex="0" @keydown.enter.prevent.stop="selectedBankCode = code; dropdownOpen = false; $event.target.closest('button').focus()" @keydown.space.prevent.stop="selectedBankCode = code; dropdownOpen = false; $event.target.closest('button').focus()"
                   class="flex items-center px-4 py-2.5 text-sm hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer focus:outline-none focus:bg-gray-100 dark:focus:bg-gray-600">
                <img :src="bank.logo" :alt="lang === 'en' ? bank.name + ' logo' : 'ÿ¥ÿπÿßÿ± ' + bank.ar" class="w-5 h-5 flex-shrink-0 object-contain" :class="lang === 'ar' ? 'ml-3' : 'mr-3'" />
                <span x-text="lang === 'en' ? bank.name : bank.ar"></span>
              </div>
            </template>
          </div>
        </div>
      </div>

      <button
        @click="generateIban()"
        type="button"
        class="w-full text-base bg-gradient-to-r from-green-500 to-emerald-600 dark:from-green-600 dark:to-emerald-700 text-white px-6 py-3 rounded-full relative transition-all duration-300 font-semibold flex items-center justify-center gap-2 hover:ring-4 hover:ring-green-300/40 dark:hover:ring-green-500/30 disabled:opacity-70 disabled:cursor-not-allowed focus:outline-none focus:ring-4 focus:ring-green-300/40 dark:focus:ring-green-500/30"
        :disabled="generating"
        :class="{ 'opacity-75 cursor-wait': generating }"
        x-ref="generateButton"
      >
        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" :class="{ 'animate-spin-half': generating }"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
        <span x-text="generating ? (lang === 'en' ? 'Generating...' : 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ŸàŸÑŸäÿØ...') : (lang === 'en' ? 'Generate IBAN' : 'ÿ™ŸàŸÑŸäÿØ ÿ¢Ÿäÿ®ÿßŸÜ')"></span>
      </button>
    </section>

    <section x-show="activeTab==='card'" aria-labelledby="card-heading" class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-md dark:text-white p-6 sm:p-8 rounded-2xl shadow-xl w-full text-center transition-all duration-300 flex flex-col" x-cloak>
      <div class="mb-6">
        <h1 id="card-heading" class="text-2xl font-bold flex items-center justify-center gap-2 text-gray-900 dark:text-white" x-text="lang === 'en' ? 'üá∏üá¶ Credit Card Generator' : 'ŸÖŸàŸÑÿØ ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿßŸÑÿßÿ¶ÿ™ŸÖÿßŸÜ üá∏üá¶'"></h1>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" x-text="lang === 'en' ? 'Generate random Saudi credit card' : 'ÿ™ŸàŸÑŸäÿØ ÿ®ÿ∑ÿßŸÇÿ© ÿßÿ¶ÿ™ŸÖÿßŸÜ ÿ≥ÿπŸàÿØŸäÿ© ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ©'"></p>
      </div>

      <div class="mb-6 text-left min-h-[110px] flex flex-col justify-center p-4 rounded-lg transition-colors duration-300 overflow-hidden" :class="['transition-all','duration-500','rounded-lg']" :style="darkMode ? 'background-color: rgba(107,114,128,0.2)' : 'background-color: #fffde7'">
        <div>
          <div class="flex justify-between items-start mb-1 gap-2">
            <p class="text-xs sm:text-sm font-semibold text-gray-600 dark:text-gray-300 flex-grow" :class="lang === 'ar' ? 'text-right' : 'text-left'" x-text="lang === 'en' ? 'Generated Card' : 'ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑŸÖŸàŸÑÿØÿ©'"></p>
            <button
              @click="copyCard()"
              :disabled="!generatedCard"
              type="button"
              class="text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 disabled:opacity-50 disabled:cursor-not-allowed transition transform active:scale-95 flex-shrink-0"
              :aria-label="lang === 'en' ? 'Copy Card' : 'ŸÜÿ≥ÿÆ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©'"
              :title="lang === 'en' ? 'Copy Card' : 'ŸÜÿ≥ÿÆ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©'">
              <svg class="w-[18px] h-[18px]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
            </button>
          </div>
          <p class="text-blue-700 dark:text-blue-400 font-mono break-words text-lg md:text-xl min-h-[2rem] leading-tight force-ltr" x-text="generatedCard ? formatCardNumber(generatedCard.number) : '#### #### #### ####'"></p>
          <p class="text-xs text-gray-600 dark:text-gray-400 mt-2" :class="lang === 'ar' ? 'text-right' : 'text-left'" x-text="generatedCard ? generatedCard.name : (lang === 'en' ? 'FULL NAME' : 'ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ')"></p>
          <p class="text-xs text-gray-600 dark:text-gray-400 mt-1" :class="lang === 'ar' ? 'text-right' : 'text-left'" x-text="generatedCard ? (lang === 'en' ? 'Expiry: ' + generatedCard.expiry : 'ÿßŸÜÿ™Ÿáÿßÿ°: ' + generatedCard.expiry) : (lang === 'en' ? 'Expiry: MM/YY' : 'ÿßŸÜÿ™Ÿáÿßÿ°: **/**')"></p>
          <p class="text-xs text-gray-600 dark:text-gray-400 mt-1" :class="lang === 'ar' ? 'text-right' : 'text-left'" x-text="generatedCard ? (lang === 'en' ? 'CVV: ' + generatedCard.cvv : 'ÿ±ŸÖÿ≤: ' + generatedCard.cvv) : (lang === 'en' ? 'CVV: ***' : 'ÿ±ŸÖÿ≤: ***')"></p>
        </div>
      </div>

      <button @click="generateCard()" type="button" class="w-full text-base bg-gradient-to-r from-green-500 to-emerald-600 dark:from-green-600 dark:to-emerald-700 text-white px-6 py-3 rounded-full relative transition-all duration-300 font-semibold flex items-center justify-center gap-2 hover:ring-4 hover:ring-green-300/40 dark:hover:ring-green-500/30 disabled:opacity-70 disabled:cursor-not-allowed focus:outline-none focus:ring-4 focus:ring-green-300/40 dark:focus:ring-green-500/30" :disabled="generating" :class="{ 'opacity-75 cursor-wait': generating }">
        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" :class="{ 'animate-spin-half': generating }"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
        <span x-text="generating ? (lang === 'en' ? 'Generating...' : 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ŸàŸÑŸäÿØ...') : (lang === 'en' ? 'Generate Card' : 'ÿ™ŸàŸÑŸäÿØ ÿ®ÿ∑ÿßŸÇÿ©')"></span>
      </button>
    </section>

    <section x-show="activeTab==='iban'" aria-labelledby="history-heading" class="w-full max-w-md text-left mt-8 px-1" x-cloak>
       <div class="flex justify-between items-center mb-3">
         <h2 id="history-heading" class="text-base font-semibold text-gray-700 dark:text-gray-300" x-text="lang === 'en' ? 'Recent IBANs' : 'ÿßŸÑÿ¢Ÿäÿ®ÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿÆŸäÿ±ÿ©'"></h2>
          <button
            @click="clearHistory()"
            type="button"
            :class="ibanHistory.length ? 'text-red-500 hover:text-red-700 dark:hover:text-red-400 cursor-pointer' : 'text-gray-400 dark:text-gray-500 cursor-not-allowed'"
            class="text-xs font-medium transition flex items-center gap-1 disabled:opacity-70 focus:outline-none focus:ring-1 focus:ring-red-500 rounded"
            :disabled="!ibanHistory.length"
            :aria-label="lang === 'en' ? 'Clear History' : 'ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ'"
            :title="lang === 'en' ? 'Clear History' : 'ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ'">
             <svg class="w-[14px] h-[14px]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m5 0V4a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v2"/></svg>
            <span x-text="lang === 'en' ? 'Clear' : 'ŸÖÿ≥ÿ≠'"></span>
          </button>
       </div>
      <div class="min-h-[180px]">
        <template x-if="ibanHistory.length">
          <ul class="space-y-1.5" aria-labelledby="history-heading">
            <template x-for="(item, index) in ibanHistory" :key="item.iban + index">
              <li
                class="history-list-item p-2 rounded-md transition duration-200 ease-in-out flex flex-col sm:flex-row sm:items-center sm:justify-between gap-x-3 gap-y-1.5"
                :class="{
                  'bg-white/60 dark:bg-gray-800/60 shadow-sm': index === 0,
                  'bg-white/40 dark:bg-gray-800/40': index > 0 && index % 2 !== 0,
                  'bg-white/30 dark:bg-gray-800/30': index > 0 && index % 2 === 0,
                  'opacity-100': index < 3, 'opacity-80': index === 3, 'opacity-70': index === 4,
                  'opacity-60': index === 5, 'opacity-50': index === 6,
                }"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform -translate-y-2"
                x-transition:enter-end="opacity-100 transform translate-y-0"
               >
                <div class="flex items-center gap-2 flex-grow min-w-0">
                   <span
                     class="iban-text font-mono text-gray-800 dark:text-gray-200 truncate force-ltr flex-grow"
                     x-text="formatIban(item.iban)"
                     :title="item.iban"
                   ></span>
                   <button
                     @click="copyIbanFromHistory(item.iban)"
                     type="button"
                     class="text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition transform active:scale-95 flex-shrink-0 ml-1 focus:outline-none focus:ring-1 focus:ring-blue-500 rounded"
                     :aria-label="(lang === 'en' ? 'Copy IBAN: ' : 'ŸÜÿ≥ÿÆ ÿßŸÑÿ¢Ÿäÿ®ÿßŸÜ: ') + item.iban"
                     :title="lang === 'en' ? 'Copy' : 'ŸÜÿ≥ÿÆ'">
                     <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                   </button>
                 </div>

                <div class="flex items-center gap-2 flex-shrink-0 sm:min-w-[150px]">
                   <template x-if="getBankInfoByName(item.bank)">
                     <img
                       :src="getBankInfoByName(item.bank)?.logo"
                       :alt="lang === 'en' ? item.bank + ' logo' : 'ÿ¥ÿπÿßÿ± ' + (getBankInfoByName(item.bank)?.ar || item.bank)"
                       class="w-4 h-4 object-contain block flex-shrink-0" loading="lazy"
                     />
                   </template>
                   <span
                     x-text="lang === 'en' ? item.bank : (getBankInfoByName(item.bank)?.ar || item.bank)"
                     class="truncate text-gray-600 dark:text-gray-400 text-xs block"
                     :title="lang === 'en' ? item.bank : (getBankInfoByName(item.bank)?.ar || item.bank)"
                   ></span>
                 </div>
              </li>
            </template>
          </ul>
        </template>
        <template x-if="!ibanHistory.length">
          <p class="text-sm text-center text-gray-500 dark:text-gray-400 pt-10" x-text="lang === 'en' ? 'No recent IBANs.' : 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ¢Ÿäÿ®ÿßŸÜÿßÿ™ ÿ≠ÿØŸäÿ´ÿ©.'"></p>
        </template>
      </div>
    </section>

  </main>

  <footer class="fixed bottom-4 left-4 z-30">
    <a href="https://github.com/a-almazyad/saudi-iban-generator" target="_blank" rel="noopener noreferrer" class="text-xs text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 font-medium bg-white/60 dark:bg-gray-800/60 px-2 py-1 rounded backdrop-blur-sm shadow-sm">
      GitHub Project
    </a>
  </footer>
  <div class="fixed bottom-4 right-4 text-xs text-gray-500 dark:text-gray-400 bg-white/80 dark:bg-gray-800/80 px-2 py-1 rounded shadow-sm z-30 backdrop-blur-sm">
      Version: <span id="version-code">...</span>
  </div>


  <script>
    function ibanApp() {
      return {
        lang: localStorage.getItem('lang') || 'en',
        darkMode: false,
        manualToggle: false,
        generating: false,
        activeTab: 'iban',
        generatedIban: null,
        generatedCard: null,
        selectedBankCode: '',
        ibanHistory: [],
        animatedIban: [],
        animatedBankName: '',
        showToast: false,
        toastMessage: '',
        toastType: 'info',
        toastTimeout: null,

        HISTORY_LIMIT: 7,
        ANIM_CHAR_INTERVAL: 30,
        ANIM_SLOT_INTERVAL: 40,
        ANIM_IBAN_CHAR_INTERVAL: 40,
        ANIM_IBAN_SLOT_INTERVAL: 50,

        firstNames: ['ABDULLAH', 'MOHAMMED', 'FAHAD', 'SULTAN', 'TURKI'],
        middleNames: ['AHMED', 'IBN', 'ABDUL', 'BIN', 'AL'],
        lastNames: ['ALSAUD', 'ALOTAIBI', 'ALHARBI', 'ALQAHTANI', 'ALFARHAN'],

        generateRandomName() {
          const f = this.firstNames[Math.floor(Math.random() * this.firstNames.length)];
          const m = this.middleNames[Math.floor(Math.random() * this.middleNames.length)];
          const l = this.lastNames[Math.floor(Math.random() * this.lastNames.length)];
          return `${f} ${m} ${l}`;
        },

        bankOptions: {
          '5':  { name: 'Alinma Bank', ar: 'ŸÖÿµÿ±ŸÅ ÿßŸÑÿ•ŸÜŸÖÿßÿ°', logo: 'logos/alinma.png' },
          '10': { name: 'SNB', ar: 'ÿßŸÑÿ®ŸÜŸÉ ÿßŸÑÿ£ŸáŸÑŸä ÿßŸÑÿ≥ÿπŸàÿØŸä', logo: 'logos/snb.png' },
          '15': { name: 'Bank Albilad', ar: 'ÿ®ŸÜŸÉ ÿßŸÑÿ®ŸÑÿßÿØ', logo: 'logos/bilad.png' },
          '20': { name: 'Riyad Bank', ar: 'ÿ®ŸÜŸÉ ÿßŸÑÿ±Ÿäÿßÿ∂', logo: 'logos/riyad.png' },
          '30': { name: 'Arab National Bank', ar: 'ÿßŸÑÿ®ŸÜŸÉ ÿßŸÑÿπÿ±ÿ®Ÿä ÿßŸÑŸàÿ∑ŸÜŸä', logo: 'logos/anb.png' },
          '36': { name: 'D360 Bank', ar: 'ÿ®ŸÜŸÉ ÿØŸäŸ£Ÿ¶Ÿ†', logo: 'logos/d360.png' },
          '45': { name: 'SABB', ar: 'ÿ≥ÿßÿ®', logo: 'logos/sabb.png' },
          '55': { name: 'BSF', ar: 'ÿßŸÑÿ®ŸÜŸÉ ÿßŸÑÿ≥ÿπŸàÿØŸä ÿßŸÑŸÅÿ±ŸÜÿ≥Ÿä', logo: 'logos/fransi.png' },
          '60': { name: 'Bank AlJazira', ar: 'ÿ®ŸÜŸÉ ÿßŸÑÿ¨ÿ≤Ÿäÿ±ÿ©', logo: 'logos/jazira.png' },
          '65': { name: 'Investment Bank', ar: 'ÿßŸÑÿ®ŸÜŸÉ ÿßŸÑÿ≥ÿπŸàÿØŸä ŸÑŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±', logo: 'logos/saib.png' },
          '78': { name: 'STC Bank', ar: 'ÿ®ŸÜŸÉ ÿ•ÿ≥ ÿ™Ÿä ÿ≥Ÿä', logo: 'logos/stc.png' },
          '80': { name: 'Al Rajhi Bank', ar: 'ŸÖÿµÿ±ŸÅ ÿßŸÑÿ±ÿßÿ¨ÿ≠Ÿä', logo: 'logos/rajhi.png' }
        },

        init() {
          const manual = localStorage.getItem('darkMode');
          this.manualToggle = (manual === 'true' || manual === 'false');
          this.darkMode = document.documentElement.classList.contains('dark');
          this.lang = localStorage.getItem('lang') || 'en';
          this.loadHistory();
          this.fetchVersion();

          this.$watch('lang', (newLang) => {
            if (this.generatedIban && this.generatedIban.bankCode) {
                const bankInfo = this.bankOptions[this.generatedIban.bankCode];
                if(bankInfo) {
                    this.generatedIban.bank = newLang === 'en' ? bankInfo.name : bankInfo.ar;
                    this.animatedBankName = this.generatedIban.bank;
                }
            }
          });
        },

        computedBank() {
          return this.bankOptions[this.selectedBankCode] || null;
        },

        getBankInfoByName(englishName) {
            return Object.values(this.bankOptions).find(b => b.name === englishName) || null;
        },

        fetchVersion() {
          fetch('version.txt?t=' + Date.now())
            .then(res => {
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                return res.text();
            })
            .then(v => {
              const el = document.getElementById('version-code');
              if (el) el.textContent = v.trim() || 'N/A';
            })
            .catch(err => {
              console.warn('[Version Fetch Error]', err);
              const el = document.getElementById('version-code');
              if (el) el.textContent = 'N/A';
            });
        },

        toggleTheme() {
          this.manualToggle = true;
          this.darkMode = !this.darkMode;
        },

        loadHistory() {
          try {
            const storedHistory = JSON.parse(localStorage.getItem('ibanHistory') || '[]');
            if (Array.isArray(storedHistory) && storedHistory.every(item => typeof item === 'object' && item !== null && item.iban && item.bank)) {
              this.ibanHistory = storedHistory.slice(0, this.HISTORY_LIMIT);
            } else {
              this.ibanHistory = [];
              if (localStorage.getItem('ibanHistory')) {
                  localStorage.removeItem('ibanHistory');
              }
            }
          } catch (e) {
            console.error("Error loading history:", e);
            this.ibanHistory = [];
            localStorage.removeItem('ibanHistory');
          }
        },

        generateIban() {
          if (this.generating) return;
          this.generating = true;

          setTimeout(() => {
            try {
              let actualBankCode = this.selectedBankCode;
              if (!actualBankCode) {
                const keys = Object.keys(this.bankOptions);
                actualBankCode = keys[Math.floor(Math.random() * keys.length)];
              }

              const bankInfo = this.bankOptions[actualBankCode];
              if (!bankInfo) throw new Error(`Invalid bank code: ${actualBankCode}`);

              const paddedBankCode = actualBankCode.toString().padStart(2, '0');
              let accountNumber = Array.from({length: 18}, () => Math.floor(Math.random() * 10)).join('');
              const bban = paddedBankCode + accountNumber;
              const checkDigits = this.calculateCheckDigits('SA', bban);

              if (checkDigits === 'XX') throw new Error('Check digit calculation failed.');

              const iban = 'SA' + checkDigits + bban;
              const displayBankName = this.lang === 'en' ? bankInfo.name : bankInfo.ar;
              const storedBankName = bankInfo.name;

              this.generatedIban = { iban, bank: displayBankName, bankCode: actualBankCode };

              this.$nextTick(() => {
                const ibanBox = document.querySelector('[data-iban-highlight]');
                if (ibanBox) {
                  ibanBox.classList.remove('pulse-highlight');
                  void ibanBox.offsetWidth;
                  ibanBox.classList.add('pulse-highlight');
                }
                this.animateText('animatedBankName', displayBankName, this.ANIM_CHAR_INTERVAL, this.ANIM_SLOT_INTERVAL);
                this.animateIban('animatedIban', iban, this.ANIM_IBAN_CHAR_INTERVAL, this.ANIM_IBAN_SLOT_INTERVAL);
              });

              if (!this.ibanHistory.some(item => item.iban === iban)) {
                this.ibanHistory.unshift({ iban, bank: storedBankName });
                this.ibanHistory = this.ibanHistory.slice(0, this.HISTORY_LIMIT);
                localStorage.setItem('ibanHistory', JSON.stringify(this.ibanHistory));
              }
            } catch (error) {
                console.error("Error generating IBAN:", error);
                this.showToastMessage(this.lang === 'en' ? 'Error generating IBAN.' : 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ¢Ÿäÿ®ÿßŸÜ.', 'error');
                this.generatedIban = null;
                this.animatedIban = [];
                this.animatedBankName = '';
            } finally {
                setTimeout(() => { this.generating = false; }, 400);
            }
          }, 50);
        },

        calculateCheckDigits(countryCode, bban) {
          const rearranged = bban + countryCode + '00';
          let converted = '';
          for (const ch of rearranged) {
            converted += isNaN(ch) ? (ch.toUpperCase().charCodeAt(0) - 55).toString() : ch;
          }
          try {
            const mod97 = BigInt(converted) % 97n;
            return String(98n - mod97).padStart(2, '0');
          } catch (e) {
            console.error("Check digit calculation failed:", e);
            return 'XX';
          }
        },


          generateCard() {
            if (this.generating) return;
            this.generating = true;
            setTimeout(() => {
              try {
                const number = window.CreditCard.generateVisaNumber();

              const now = new Date();
              const startMonth = now.getFullYear() * 12 + now.getMonth();
              const endMonth = startMonth + 60;
              const randMonth = Math.floor(Math.random() * (endMonth - startMonth + 1)) + startMonth;
              const year = Math.floor(randMonth / 12);
              const month = randMonth % 12;
              const expiry = String(month + 1).padStart(2, '0') + '/' + String(year % 100).padStart(2, '0');

              const cvv = Math.floor(100 + Math.random() * 900);
              const name = this.generateRandomName();

              this.generatedCard = { number, name, expiry, cvv };
              this.showToastMessage(this.lang === 'en' ? 'Card Generated!' : 'ÿ™ŸÖ ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©!', 'success');
            } finally {
              setTimeout(() => { this.generating = false; }, 400);
            }
          }, 50);
        },

        copyIban() {
          const ibanToCopy = this.generatedIban?.iban;
          if (!ibanToCopy) {
            this.showToastMessage(this.lang === 'en' ? 'Generate an IBAN first.' : 'ŸÇŸÖ ÿ®ÿ™ŸàŸÑŸäÿØ ÿ¢Ÿäÿ®ÿßŸÜ ÿ£ŸàŸÑÿßŸã.', 'info');
            return;
          }
          this.copyToClipboard(ibanToCopy, this.lang === 'en' ? 'IBAN copied!' : '!ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ¢Ÿäÿ®ÿßŸÜ');
        },

        copyIbanFromHistory(iban) {
            if (!iban) return;
            this.copyToClipboard(iban, this.lang === 'en' ? 'IBAN copied from history!' : '!ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ¢Ÿäÿ®ÿßŸÜ ŸÖŸÜ ÿßŸÑÿ≥ÿ¨ŸÑ');
        },

        copyCard() {
          const cardNum = this.generatedCard?.number;
          if (!cardNum) {
            this.showToastMessage(this.lang === 'en' ? 'Generate a card first.' : 'ŸÇŸÖ ÿ®ÿ™ŸàŸÑŸäÿØ ÿ®ÿ∑ÿßŸÇÿ© ÿ£ŸàŸÑÿßŸã.', 'info');
            return;
          }
          this.copyToClipboard(cardNum, this.lang === 'en' ? 'Card copied!' : '!ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©');
        },

        copyCardFromHistory(num) {
            if (!num) return;
            this.copyToClipboard(num, this.lang === 'en' ? 'Card copied from history!' : '!ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ŸÖŸÜ ÿßŸÑÿ≥ÿ¨ŸÑ');
        },

        copyToClipboard(text, successMessage) {
          if (!text) return;
          if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
              navigator.clipboard.writeText(text)
                .then(() => this.showToastMessage(successMessage, 'success'))
                .catch(err => {
                    console.warn('Clipboard API failed, falling back:', err);
                    this.fallbackCopy(text, successMessage);
                });
          } else {
              console.warn('Clipboard API not available, using fallback.');
              this.fallbackCopy(text, successMessage);
          }
        },

        fallbackCopy(text, successMessage) {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.setAttribute('readonly', '');
          textarea.style.position = 'absolute';
          textarea.style.left = '-9999px';
          document.body.appendChild(textarea);
          let copied = false;
          try {
            textarea.select();
            copied = document.execCommand('copy');
          } catch (err) {
            console.error('Fallback copy execCommand failed:', err);
          }
          document.body.removeChild(textarea);

          if (copied) {
              this.showToastMessage(successMessage, 'success');
          } else {
              this.showToastMessage(this.lang === 'en' ? 'Failed to copy.' : '.ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ≥ÿÆ', 'error');
          }
        },

        clearHistory() {
          if (this.ibanHistory.length === 0) {
            this.showToastMessage(this.lang === 'en' ? 'History is already empty' : 'ÿßŸÑÿ≥ÿ¨ŸÑ ŸÅÿßÿ±ÿ∫ ÿ®ÿßŸÑŸÅÿπŸÑ', 'info');
            return;
          }

          const listItems = document.querySelectorAll('.history-list-item');
          listItems.forEach((el, i) => {
            el.style.transition = `opacity 0.3s ease ${i * 0.03}s, transform 0.3s ease ${i * 0.03}s`;
            requestAnimationFrame(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(10px)';
            });
          });

          setTimeout(() => {
            this.ibanHistory = [];
            localStorage.removeItem('ibanHistory');
            this.showToastMessage(this.lang === 'en' ? 'History cleared' : 'ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ', 'success');
            this.$refs.generateButton?.focus();
          }, listItems.length * 30 + 350);
        },

        showToastMessage(msg, type = 'info') {
          if (this.toastTimeout) clearTimeout(this.toastTimeout);
          this.toastMessage = msg;
          this.toastType = type;
          this.showToast = true;
          this.toastTimeout = setTimeout(() => {
              this.showToast = false;
          }, 2500);
        },

        formatIban(iban) {
            if (!iban || typeof iban !== 'string' || iban.length !== 24) return iban;
            return iban.replace(/(SA\d{2})(\d{4})(\d{4})(\d{4})(\d{4})(\d{4})/, '$1 $2 $3 $4 $5 $6');
        },

        formatCardNumber(num) {
            if (!num || typeof num !== 'string' || num.length !== 16) return num;
            return num.replace(/(\d{4})(\d{4})(\d{4})(\d{4})/, '$1 $2 $3 $4');
        },

        animateText(propName, targetText, charIntervalSpeed, slotIntervalSpeed) {
            if (window[`${propName}Interval`]) clearInterval(window[`${propName}Interval`]);

            this[propName] = '';
            const targetChars = targetText.split('');
            let currentChars = Array(targetChars.length).fill(' ');
            let charIndex = 0;
            let intervalId;

            intervalId = setInterval(() => {
                if (charIndex >= targetChars.length) {
                    clearInterval(intervalId);
                    window[`${propName}Interval`] = null;
                    this[propName] = targetText;
                    return;
                }
                const currentSlot = charIndex;
                let cycleCount = 0;
                const maxCycles = 3;
                let charIntervalId = setInterval(() => {
                    if (cycleCount >= maxCycles) {
                        clearInterval(charIntervalId);
                        currentChars[currentSlot] = targetChars[currentSlot];
                        this[propName] = currentChars.join('');
                    } else {
                        currentChars[currentSlot] = String.fromCharCode(33 + Math.random() * 94);
                        this[propName] = currentChars.join('');
                        cycleCount++;
                    }
                }, charIntervalSpeed);
                charIndex++;
            }, slotIntervalSpeed);
            window[`${propName}Interval`] = intervalId;
        },

        animateIban(propName, targetIban, charIntervalSpeed, slotIntervalSpeed) {
            if (window[`${propName}Interval`]) clearInterval(window[`${propName}Interval`]);

            const targetChars = targetIban.split('');
            if (!Array.isArray(this[propName]) || this[propName].length !== targetChars.length) {
                 this[propName] = ['S', 'A', ...Array(targetChars.length - 2).fill('X')];
            }
            let currentChars = [...this[propName]];
            let charIndex = 2;
            let intervalId;

            intervalId = setInterval(() => {
                if (charIndex >= targetChars.length) {
                    clearInterval(intervalId);
                    window[`${propName}Interval`] = null;
                    this[propName] = [...targetChars];
                    return;
                }
                const currentSlot = charIndex;
                let cycleCount = 0;
                const maxCycles = 4;
                let charIntervalId = setInterval(() => {
                    if (cycleCount >= maxCycles) {
                        clearInterval(charIntervalId);
                        currentChars[currentSlot] = targetChars[currentSlot];
                        this[propName] = [...currentChars];
                    } else {
                        currentChars[currentSlot] = Math.floor(Math.random() * 10).toString();
                        this[propName] = [...currentChars];
                        cycleCount++;
                    }
                }, charIntervalSpeed);
                charIndex++;
            }, slotIntervalSpeed);
            window[`${propName}Interval`] = intervalId;
        },
      }
    }
  </script>

</body>
</html>
